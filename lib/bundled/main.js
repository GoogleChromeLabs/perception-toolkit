/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

if(!self.perceptionToolkitLoader){const e=async e=>{if(!n[e]&&(await new Promise(async t=>{if("document"in self){const n=document.createElement("script");n.src=function(){let e="";return window.PerceptionToolkit&&window.PerceptionToolkit.config&&window.PerceptionToolkit.config.root&&(e=window.PerceptionToolkit.config.root),`${e}/lib/bundled`}()+e.slice(1),n.defer=!0,document.head.appendChild(n),n.onload=t}else importScripts(e),t()}),!n[e]))throw new Error(`Module ${e} didnâ€™t register its module`);return n[e]},t=async(t,n)=>{const o=await Promise.all(t.map(e));n(1===o.length?o[0]:o)},n={require:Promise.resolve(t)};self.perceptionToolkitLoader=((t,o,i)=>{n[t]||(n[t]=new Promise(async t=>{let n={};const a={uri:location.origin+function(){let e="";return window.PerceptionToolkit&&window.PerceptionToolkit.config&&window.PerceptionToolkit.config.root&&(e=window.PerceptionToolkit.config.root),`${e}/lib/bundled`}()+name.slice(1)},r=await Promise.all(o.map(t=>"exports"===t?n:"module"===t?a:e(t))),c=i(...r);n.default||(n.default=c),t(n)}))})}perceptionToolkitLoader("./main.js",["exports","./pt-chunk-cf46731c.js","./pt-chunk-3c8c2440.js","./pt-chunk-d3dcaf5d.js","./meaning-maker.js"],function(e,t,n,o,i){"use strict";let a;async function r(e,{context:t=window,forceNewDetector:o=!1,polyfillRequired:i=!1,polyfillPrefix:c=""}={}){(i||t===window&&!("BarcodeDetector"in t))&&(n.log("Using barcode detection polyfill",n.DEBUG_LEVEL.INFO,"BarcodeDetector"),await n.injectScript(`${c}/lib/polyfills/barcode-detector.js`)),a&&!o||(a=new t.BarcodeDetector),"isReady"in a&&await a.isReady;try{return await a.detect(e)}catch(a){return i?[]:(n.log(`Detection failed: ${a.message}`,n.DEBUG_LEVEL.WARNING),await r(e,{context:t,forceNewDetector:o,polyfillPrefix:c,polyfillRequired:!0}))}}const c=document.createElement("div");function d(e,t=document.body){return c.textContent=e,t.appendChild(c),c}function s(){c.remove()}function l(e=200){"vibrate"in navigator&&navigator.vibrate(e)}c.attachShadow({mode:"open"}).innerHTML='<style>\n:host {\n  --baseline: 12px;\n  position: fixed;\n  display: block;\n  top: 50%;\n  left: 50%;\n  min-width: 280px;\n  padding: var(--baseline) calc(var(--baseline) * 2);\n  background: rgba(0, 0, 0, 0.5);\n  border-radius: 20px;\n  color: #FFF;\n  transform: translate(-50%, -50%);\n  text-align: center;\n  font-family: Arial, Helvetica, sans-serif;\n  font-size: 18px;\n  z-index: 2;\n}\n</style><span class="content"><slot></slot></span>';const u=new Map,f=new i.MeaningMaker;customElements.define(t.StreamCapture.defaultTagName,t.StreamCapture),customElements.define(t.Card.defaultTagName,t.Card),customElements.define(t.ActionButton.defaultTagName,t.ActionButton),window.addEventListener(t.frameEvent,async function(e){if(T)return;T=!0;const i=e.target,{detail:a}=e,{detectionMode:c,imgData:l}=a,p=await r(l,{polyfillPrefix:m});for(const e of p){const o=u.has(e.rawValue);u.set(e.rawValue,self.performance.now()),o||n.fire(t.markerDetect,i,e.rawValue)}p.length>0?(clearTimeout(h),s()):c&&"active"===c&&d("No markers found");i.paused=!1,setTimeout(async()=>{const e=self.performance.now(),t=[];for(const[n,o]of u.entries()){if(e-o<1e3)continue;const i={type:"qrcode",value:n};t.push(f.markerLost(i)),u.delete(n)}await Promise.all(t),T=!1},1e3);const w=document.querySelector(o.DotLoader.defaultTagName);if(!w)return;w.remove()}),window.addEventListener("offline",P),window.addEventListener("online",P),n.enableLogLevel(n.DEBUG_LEVEL.ERROR);const m=window.PerceptionToolkit.config.root||"",p=r(new ImageData(1,1),{polyfillPrefix:m});async function w({detectionMode:e="passive",sitemapUrl:o}){try{await p,await f.init(),o&&await f.loadArtifactsFromJsonldUrl(new URL(o,document.URL)),await async function(e){"passive"===e?b.captureRate=600:(d("Tap to capture"),b.addEventListener("click",async()=>{b.paused=!0,d("Processing...");const o=await b.captureFrame();n.fire(t.frameEvent,b,{imgData:o,detectionMode:e})}));b.captureScale=.8,b.addEventListener(t.closeEvent,L),b.addEventListener(t.markerDetect,g);try{v=await navigator.mediaDevices.getUserMedia(y);const e=await navigator.mediaDevices.enumerateDevices(),o=await async function(e){return e.filter(e=>"videoinput"===e.kind).some(e=>{if(!("getCapabilities"in e))return!1;const t=e.getCapabilities();return!!t.facingMode&&t.facingMode.find(e=>"environment")})}(e);b.flipped=!o,window.addEventListener("visibilitychange",E),b.start(v),document.body.appendChild(b),h=setTimeout(()=>{d("Make sure the marker is inside the box.")},window.PerceptionToolkit.config.hintTimeout||5e3)}catch(e){n.fire(t.cameraAccessDenied,window)}}(e)}catch(e){n.log(e.message,n.DEBUG_LEVEL.ERROR,"Begin detection")}}async function g(e){const{detail:o}=e,i={type:"qrcode",value:o},{shouldLoadArtifactsFrom:a}=window.PerceptionToolkit.config,r=await f.markerFound(i,a);n.fire(t.markerChanges,b,r).defaultPrevented||(l(200),async function(e){const{cardContainer:n,cardUrlLabel:o}=window.PerceptionToolkit.config;if(n&&!n.hasChildNodes())for(const{content:i}of e.found){const e=i,a=new t.Card;if(a.src=e,n.appendChild(a),void 0===e.url)continue;const r=e.url,c=new t.ActionButton;c.label=o||"View Details",c.addEventListener("click",()=>{r&&(window.location.href=r)}),a.appendChild(c)}}(r))}let v;const y={video:{facingMode:"environment"}};let h;const b=new t.StreamCapture;let k=!1;async function E(){if(console.log("Visibility change"),!k&&null!==b.parentNode)if(document.hidden)b.stop();else{if(k=!0,v=await navigator.mediaDevices.getUserMedia(y),k=!1,document.hidden)return;b.stop(),b.start(v)}}function L(){b.stop(),b.remove(),s(),clearTimeout(h),window.removeEventListener("visibilitychange",E);const e=document.querySelector(n.OnboardingCard.defaultTagName);e&&e.remove()}let T=!1;function P(){const e=navigator.onLine;document.body.querySelector(t.StreamCapture.defaultTagName)&&(e?s():d("Currently offline. Please reconnect to the network."))}e.ActionButton=t.ActionButton,e.Card=t.Card,e.close=L,e.initialize=async function(e){const t=document.querySelector(n.OnboardingCard.defaultTagName);t?t.addEventListener(n.OnboardingCard.onboardingFinishedEvent,()=>{t.remove(),w(e)}):w(e)},e.vibrate=l,Object.defineProperty(e,"__esModule",{value:!0})});
